import{r as v,S as X,y as Z,j as e}from"./index-B5isPGjJ.js";import{u as G,s as h}from"./useUsuario-ByIR5A8c.js";import{N as V}from"./Navbar-CKa8b93H.js";import{F as R}from"./Footer-KUXXIXDs.js";import{c as ee,a as se,b as ae,n as te}from"./notificaciones-CWB8BhBt.js";import{o as oe,v as re,r as le}from"./margin.props-GYc4Hiw3.js";const ie=["1","2","3","4","5"],ne=["surface","classic","ghost"],ce={...oe,size:{type:"enum",className:"rt-r-size",values:ie,default:"1",responsive:!0},variant:{type:"enum",className:"rt-variant",values:ne,default:"surface"}},g=v.forwardRef((i,D)=>{const{asChild:a,className:f,...j}=re(i,ce,le),y=a?X:"div";return v.createElement(y,{ref:D,...j,className:Z("rt-reset","rt-BaseCard","rt-Card",f)})});g.displayName="Card";function be(){const{usuario:i,loading:D}=G(),[a,f]=v.useState({series:{total:0,viendo:0,vistas:0,pendientes:0},peliculas:{total:0,vistas:0,pendientes:0},episodios:{vistos:0,tiempoTotal:0},generosFavoritos:[],añoActividad:new Date().getFullYear(),racha:{actual:0,mejor:0},logros:{desbloqueados:[],proximos:[],resumen:{total:0,desbloqueados:0,porcentaje:0}},loading:!0}),[j,y]=v.useState(!1);v.useEffect(()=>{i!=null&&i.id&&z()},[i]);const z=async()=>{var o,c;try{f(s=>({...s,loading:!0}));const{data:t,error:x}=await h.from("catalogo_usuario").select(`
          estado,
          contenido!inner (
            media_type,
            nombre,
            nombre_original,
            generos
          )
        `).eq("user_id",i.id).eq("contenido.media_type","tv"),{data:l,error:p}=await h.from("catalogo_usuario").select(`
          estado,
          contenido!inner (
            media_type,
            nombre,
            nombre_original,
            duracion,
            generos
          )
        `).eq("user_id",i.id).eq("contenido.media_type","movie");x&&console.error("Error cargando series:",x);const E={total:(t==null?void 0:t.length)||0,viendo:(t==null?void 0:t.filter(s=>s.estado==="viendo").length)||0,vistas:(t==null?void 0:t.filter(s=>(s.estado||"").toLowerCase()==="vista").length)||0,pendientes:(t==null?void 0:t.filter(s=>s.estado==="pendiente").length)||0};p&&console.error("Error cargando películas:",p);const w=(l==null?void 0:l.filter(s=>s.estado==="vista"))||[],d=w.reduce((s,r)=>{var n;return s+(((n=r.contenido)==null?void 0:n.duracion)||120)},0),m={total:(l==null?void 0:l.length)||0,vistas:w.length,pendientes:(l==null?void 0:l.filter(s=>s.estado==="pendiente").length)||0,tiempoTotal:d},{count:b,error:N}=await h.from("episodios_vistos").select("episodio_id",{count:"exact",head:!0}).eq("user_id",i.id);N&&console.error("Error cargando episodios vistos:",N);const{data:_,error:de}=await h.from("episodios_vistos").select(`
    episodio_id,
    episodios (
      duracion
    )
  `).eq("user_id",i.id).range(0,2999),O=(_==null?void 0:_.reduce((s,r)=>{var k;const n=((k=r.episodios)==null?void 0:k.duracion)||45;return s+n},0))||0,S=new Map;[...t||[],...l||[]].forEach(s=>{var r;(r=s.contenido)!=null&&r.generos&&s.contenido.generos.forEach(n=>{S.set(n,(S.get(n)||0)+1)})});const U=Array.from(S.entries()).sort((s,r)=>r[1]-s[1]).slice(0,5).map(([s,r])=>({genero:s,cantidad:r})),{data:Y,error:C}=await h.from("catalogo_usuario").select("creado_en").eq("user_id",i.id).order("creado_en",{ascending:!1}).limit(30);C&&console.error("Error cargando actividad:",C);const B=I(Y||[]),T=new Date;T.setDate(1),T.setHours(0,0,0,0);const{data:A}=await h.from("catalogo_usuario").select("id").eq("user_id",i.id).gte("creado_en",T.toISOString()),H=(A==null?void 0:A.length)||0,{data:me,error:$}=await h.from("catalogo_usuario").select(`
          estado,
          contenido!inner (
            media_type,
            nombre,
            nombre_original,
            duracion
          )
        `).eq("user_id",i.id).eq("contenido.media_type","movie").eq("estado","vista");$&&console.error("Error cargando detalles de películas vistas:",$);const J=((o=l==null?void 0:l.filter(s=>s.estado==="vista"))==null?void 0:o.map(s=>({nombre:s.contenido.nombre,nombre_original:s.contenido.nombre_original,duracion:s.contenido.duracion})))||[],K=((c=t==null?void 0:t.filter(s=>(s.estado||"").toLowerCase()==="vista"))==null?void 0:c.map(s=>({nombre:s.contenido.nombre,nombre_original:s.contenido.nombre_original})))||[],q={series:E,peliculas:m,episodios:{vistos:b||0,tiempoTotal:O},generosFavoritos:U,añoActividad:new Date().getFullYear(),racha:B,contenidoNuevoEsteMes:H,peliculasVistas:J,episodiosNocturnos:0,episodiosFinDeSemana:0,seriesVistas:K},F=ee(q),Q=se(q),W=ae(q),{data:u,error:P}=await h.from("logros_usuario").select("logro_id, desbloqueado_en").eq("user_id",i.id);P&&console.error("Error cargando logros guardados:",P);const xe=(u==null?void 0:u.map(s=>s.logro_id))||[];for(const s of F)if(!(u==null?void 0:u.some(n=>n.logro_id===s.id))){const n=new Date().toISOString();await h.from("logros_usuario").upsert([{user_id:i.id,logro_id:s.id,desbloqueado_en:n}],{onConflict:["user_id","logro_id"]}),await te(i.id,{...s,desbloqueado_en:n}),s.desbloqueado_en=n}let L=F.map(s=>{const r=u==null?void 0:u.find(n=>n.logro_id===s.id);return{...s,desbloqueado_en:s.desbloqueado_en||(r==null?void 0:r.desbloqueado_en)||null}});L=L.sort((s,r)=>s.desbloqueado_en?r.desbloqueado_en?new Date(r.desbloqueado_en)-new Date(s.desbloqueado_en):-1:1),f({...q,logros:{desbloqueados:L,proximos:Q,resumen:W},loading:!1})}catch(t){console.error("Error cargando estadísticas:",t),f(x=>({...x,loading:!1}))}},I=o=>{if(!o.length)return{actual:0,mejor:0};const c=o.map(d=>new Date(d.created_at||d.creado_en).toDateString()),t=[...new Set(c)].sort((d,m)=>new Date(m)-new Date(d));let x=0,l=0,p=1;const E=new Date().toDateString(),w=new Date(Date.now()-864e5).toDateString();if(t.length>0){const d=t[0];if(d===E||d===w){x=1;for(let m=1;m<t.length;m++){const b=new Date(t[m-1]),N=new Date(t[m]);if(Math.round((b-N)/864e5)===1)x++;else break}}}if(t.length>1){p=1;for(let d=1;d<t.length;d++){const m=new Date(t[d-1]),b=new Date(t[d]);Math.round((m-b)/864e5)===1?(p++,l=Math.max(l,p)):p=1}}return{actual:x,mejor:Math.max(l,x)}},M=o=>{const c=Math.floor(o/60),t=Math.floor(c/24);return t>0?`${t}d ${c%24}h`:c>0?`${c}h ${o%60}m`:`${o}m`};return a.loading||D?e.jsxs("div",{className:"min-h-screen flex flex-col",children:[e.jsx(V,{}),e.jsx("main",{className:"flex-1 pt-20 px-4",children:e.jsx("div",{className:"max-w-4xl mx-auto",children:e.jsxs("div",{className:"animate-pulse",children:[e.jsx("div",{className:"h-8 bg-gray-200 rounded w-1/3 mb-8"}),e.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6",children:[...Array(8)].map((o,c)=>e.jsx("div",{className:"h-32 bg-gray-200 rounded"},c))})]})})}),e.jsx(R,{})]}):e.jsxs("div",{className:"min-h-screen flex flex-col",children:[e.jsx(V,{}),e.jsx("main",{className:"flex-1 pt-20 px-4",children:e.jsxs("div",{className:"max-w-6xl mx-auto",children:[e.jsxs("div",{className:"mb-8",children:[e.jsx("h1",{className:"text-3xl font-bold text-gray-900 mb-2",children:"Mi Perfil"}),e.jsxs("p",{className:"text-gray-600",children:["Resumen de tu actividad en ",a.añoActividad]})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8",children:[e.jsxs(g,{className:"p-6",children:[e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsx("h3",{className:"text-lg font-semibold text-gray-900",children:"Series"}),e.jsx("span",{className:"text-2xl",children:"📺"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"text-sm text-gray-600",children:"Total:"}),e.jsx("span",{className:"font-medium",children:a.series.total})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"text-sm text-gray-600",children:"Viendo:"}),e.jsx("span",{className:"font-medium text-blue-600",children:a.series.viendo})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"text-sm text-gray-600",children:"Terminadas:"}),e.jsx("span",{className:"font-medium text-green-600",children:a.series.vistas})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"text-sm text-gray-600",children:"Pendientes:"}),e.jsx("span",{className:"font-medium text-orange-600",children:a.series.pendientes})]})]})]}),e.jsxs(g,{className:"p-6",children:[e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsx("h3",{className:"text-lg font-semibold text-gray-900",children:"Películas"}),e.jsx("span",{className:"text-2xl",children:"🎬"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"text-sm text-gray-600",children:"Total:"}),e.jsx("span",{className:"font-medium",children:a.peliculas.total})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"text-sm text-gray-600",children:"Vistas:"}),e.jsx("span",{className:"font-medium text-green-600",children:a.peliculas.vistas})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"text-sm text-gray-600",children:"Pendientes:"}),e.jsx("span",{className:"font-medium text-orange-600",children:a.peliculas.pendientes})]}),a.peliculas.tiempoTotal>0&&e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"text-sm text-gray-600",children:"Tiempo visto:"}),e.jsx("span",{className:"font-medium text-blue-600",children:M(a.peliculas.tiempoTotal)})]})]})]}),e.jsxs(g,{className:"p-6",children:[e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsx("h3",{className:"text-lg font-semibold text-gray-900",children:"Episodios"}),e.jsx("span",{className:"text-2xl",children:"📊"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"text-sm text-gray-600",children:"Vistos:"}),e.jsx("span",{className:"font-medium",children:a.episodios.vistos})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"text-sm text-gray-600",children:"Tiempo total:"}),e.jsx("span",{className:"font-medium text-purple-600",children:M(a.episodios.tiempoTotal)})]})]})]}),e.jsxs(g,{className:"p-6",children:[e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsx("h3",{className:"text-lg font-semibold text-gray-900",children:"Racha"}),e.jsx("span",{className:"text-2xl",children:"🔥"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"text-sm text-gray-600",children:"Actual:"}),e.jsxs("span",{className:"font-medium text-orange-600",children:[a.racha.actual," días"]})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"text-sm text-gray-600",children:"Mejor:"}),e.jsxs("span",{className:"font-medium text-red-600",children:[a.racha.mejor," días"]})]})]})]})]}),e.jsxs(g,{className:"p-6 mb-8",children:[e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsx("h3",{className:"text-lg font-semibold text-gray-900",children:"Logros"}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"text-2xl",children:"🏆"}),e.jsxs("span",{className:"text-sm text-gray-600",children:[a.logros.resumen.desbloqueados,"/",a.logros.resumen.total]})]})]}),e.jsxs("div",{className:"mb-6",children:[e.jsxs("div",{className:"flex justify-between text-sm mb-2",children:[e.jsx("span",{children:"Progreso general"}),e.jsxs("span",{children:[a.logros.resumen.porcentaje,"%"]})]}),e.jsx("div",{className:"w-full bg-gray-200 rounded-full h-3",children:e.jsx("div",{className:"bg-blue-600 h-3 rounded-full transition-all duration-300",style:{width:`${a.logros.resumen.porcentaje}%`}})})]}),a.logros.desbloqueados.length>0&&e.jsxs("div",{className:"mb-6",children:[e.jsxs("h4",{className:"text-sm font-medium text-gray-700 mb-3 flex items-center gap-2",children:[e.jsx("span",{children:"✅"}),"Logros desbloqueados (",a.logros.desbloqueados.length,")"]}),e.jsx("div",{className:"grid grid-cols-2 md:grid-cols-4 lg:grid-cols-6 gap-3",children:(j?a.logros.desbloqueados:a.logros.desbloqueados.slice(0,12)).map(o=>e.jsxs("div",{className:`text-center p-3 rounded-lg border ${o.color}`,title:o.descripcion+(o.desbloqueado_en?`
Desbloqueado: ${new Date(o.desbloqueado_en).toLocaleDateString()}`:""),children:[e.jsx("span",{className:"text-2xl mb-1 block",children:o.emoji}),e.jsx("span",{className:"text-xs font-medium block leading-tight",children:o.nombre}),o.desbloqueado_en&&e.jsx("span",{className:"text-[10px] text-gray-500 block mt-1",children:new Date(o.desbloqueado_en).toLocaleDateString()})]},o.id))}),a.logros.desbloqueados.length>12&&!j&&e.jsxs("p",{className:"text-xs text-blue-600 mt-2 cursor-pointer hover:underline",onClick:()=>y(!0),children:["+",a.logros.desbloqueados.length-12," logros más..."]}),a.logros.desbloqueados.length>12&&j&&e.jsx("p",{className:"text-xs text-blue-600 mt-2 cursor-pointer hover:underline",onClick:()=>y(!1),children:"Mostrar menos"})]}),a.logros.proximos.length>0&&e.jsxs("div",{children:[e.jsxs("h4",{className:"text-sm font-medium text-gray-700 mb-3 flex items-center gap-2",children:[e.jsx("span",{children:"🎯"}),"Próximos logros"]}),e.jsx("div",{className:"space-y-3",children:a.logros.proximos.slice(0,4).map(o=>e.jsxs("div",{className:"flex items-center gap-3 p-3 bg-gray-50 rounded-lg",children:[e.jsx("span",{className:"text-xl opacity-70",children:o.emoji}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsxs("div",{className:"flex justify-between items-center mb-1",children:[e.jsx("span",{className:"text-sm font-medium text-gray-900 truncate",children:o.nombre}),e.jsxs("span",{className:"text-xs text-gray-600 ml-2",children:[o.progreso,"%"]})]}),e.jsx("p",{className:"text-xs text-gray-600 mb-2 line-clamp-1",children:o.descripcion}),e.jsx("div",{className:"w-full bg-gray-200 rounded-full h-2",children:e.jsx("div",{className:"bg-blue-500 h-2 rounded-full transition-all duration-300",style:{width:`${o.progreso}%`}})})]})]},o.id))})]}),a.logros.desbloqueados.length===0&&e.jsxs("div",{className:"text-center py-8 text-gray-500",children:[e.jsx("span",{className:"text-4xl mb-2 block",children:"🏆"}),e.jsx("p",{className:"font-medium",children:"¡Empieza tu aventura!"}),e.jsx("p",{className:"text-sm",children:"Añade contenido y ve episodios para desbloquear logros"})]})]}),a.generosFavoritos.length>0&&e.jsxs(g,{className:"p-6 mb-8",children:[e.jsx("h3",{className:"text-lg font-semibold text-gray-900 mb-4",children:"Géneros Favoritos"}),e.jsx("div",{className:"space-y-3",children:a.generosFavoritos.map(({genero:o,cantidad:c},t)=>e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsxs("span",{className:"text-sm font-medium text-gray-700",children:["#",t+1]}),e.jsx("span",{className:"text-sm text-gray-900",children:o})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"bg-blue-200 rounded-full h-2 flex-1 min-w-20",children:e.jsx("div",{className:"bg-blue-600 h-2 rounded-full",style:{width:`${c/a.generosFavoritos[0].cantidad*100}%`}})}),e.jsx("span",{className:"text-sm font-medium text-gray-700 min-w-8",children:c})]})]},o))})]}),e.jsxs(g,{className:"p-6",children:[e.jsx("h3",{className:"text-lg font-semibold text-gray-900 mb-4",children:"Actividad de Este Mes"}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4",children:[e.jsxs("div",{className:"text-center p-4 bg-blue-50 rounded-lg",children:[e.jsx("span",{className:"text-2xl mb-2 block",children:"📅"}),e.jsx("span",{className:"text-lg font-bold text-blue-600",children:a.contenidoNuevoEsteMes||0}),e.jsx("p",{className:"text-sm text-blue-700",children:"Títulos añadidos"})]}),e.jsxs("div",{className:"text-center p-4 bg-green-50 rounded-lg",children:[e.jsx("span",{className:"text-2xl mb-2 block",children:"🔥"}),e.jsx("span",{className:"text-lg font-bold text-green-600",children:a.racha.actual}),e.jsx("p",{className:"text-sm text-green-700",children:"Días de racha"})]}),e.jsxs("div",{className:"text-center p-4 bg-purple-50 rounded-lg",children:[e.jsx("span",{className:"text-2xl mb-2 block",children:"🎯"}),e.jsx("span",{className:"text-lg font-bold text-purple-600",children:a.logros.proximos.length}),e.jsx("p",{className:"text-sm text-purple-700",children:"Logros próximos"})]})]})]})]})}),e.jsx(R,{})]})}export{be as default};
