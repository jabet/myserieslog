import{r as t,d as T,j as e,e as Y,P as $,f as O,h as D,a as L}from"./index-B5isPGjJ.js";import{u as Q,s as p}from"./useUsuario-ByIR5A8c.js";import{u as W,N as R}from"./Navbar-CKa8b93H.js";import{u as X}from"./index-DeS5Rxut.js";var E="Switch",[G,ie]=Y(E),[J,K]=G(E),A=t.forwardRef((u,a)=>{const{__scopeSwitch:c,name:o,checked:l,defaultChecked:N,required:h,disabled:x,value:f="on",onCheckedChange:b,form:i,...j}=u,[w,g]=t.useState(null),y=T(a,k=>g(k)),v=t.useRef(!1),S=w?i||!!w.closest("form"):!0,[m,C]=W({prop:l,defaultProp:N??!1,onChange:b,caller:E});return e.jsxs(J,{scope:c,checked:m,disabled:x,children:[e.jsx($.button,{type:"button",role:"switch","aria-checked":m,"aria-required":h,"data-state":F(m),"data-disabled":x?"":void 0,disabled:x,value:f,...j,ref:y,onClick:O(u.onClick,k=>{C(_=>!_),S&&(v.current=k.isPropagationStopped(),v.current||k.stopPropagation())})}),S&&e.jsx(z,{control:w,bubbles:!v.current,name:o,value:f,checked:m,required:h,disabled:x,form:i,style:{transform:"translateX(-100%)"}})]})});A.displayName=E;var M="SwitchThumb",V=t.forwardRef((u,a)=>{const{__scopeSwitch:c,...o}=u,l=K(M,c);return e.jsx($.span,{"data-state":F(l.checked),"data-disabled":l.disabled?"":void 0,...o,ref:a})});V.displayName=M;var Z="SwitchBubbleInput",z=t.forwardRef(({__scopeSwitch:u,control:a,checked:c,bubbles:o=!0,...l},N)=>{const h=t.useRef(null),x=T(h,N),f=X(c),b=D(a);return t.useEffect(()=>{const i=h.current;if(!i)return;const j=window.HTMLInputElement.prototype,g=Object.getOwnPropertyDescriptor(j,"checked").set;if(f!==c&&g){const y=new Event("click",{bubbles:o});g.call(i,c),i.dispatchEvent(y)}},[f,c,o]),e.jsx("input",{type:"checkbox","aria-hidden":!0,defaultChecked:c,...l,tabIndex:-1,ref:x,style:{...l.style,...b,position:"absolute",pointerEvents:"none",opacity:0,margin:0}})});z.displayName=Z;function F(u){return u?"checked":"unchecked"}function re(){const u=L(),{usuario:a,loading:c}=Q(),[o,l]=t.useState(""),[N,h]=t.useState([]),[x,f]=t.useState(!1),[b,i]=t.useState(""),[j,w]=t.useState([]),[g,y]=t.useState([]),[v,S]=t.useState([]);t.useEffect(()=>{a&&(m(a.id),C(a.id))},[a]),t.useEffect(()=>{if(!a||!o||o.length<2){h([]);return}f(!0);const s=setTimeout(async()=>{const{data:r,error:n}=await p.from("usuarios").select("user_id, nick").ilike("nick",`%${o}%`).neq("user_id",a.id).limit(10);n?(console.error("Buscar usuarios:",n),i("Error al buscar")):(h(r),i("")),f(!1)},300);return()=>clearTimeout(s)},[o,a]);async function m(s){const[{data:r},{data:n}]=await Promise.all([p.from("amistades").select("id, usuario1(user_id,nick)").eq("usuario2",s).eq("estado","pendiente"),p.from("amistades").select("id, usuario2(user_id,nick)").eq("usuario1",s).eq("estado","pendiente")]);w(r||[]),y(n||[])}async function C(s){const{data:r,error:n}=await p.from("amistades").select(`
        id,
        usuario1,
        usuario2,
        comparte_catalogo,
        usuarios1:usuarios!amistades_usuario1_fkey(user_id,nick),
        usuarios2:usuarios!amistades_usuario2_fkey(user_id,nick)
      `).or(`and(usuario1.eq.${s},estado.eq.aceptada),and(usuario2.eq.${s},estado.eq.aceptada)`);if(n){console.error("Cargar amigos:",n);return}const q=(r||[]).map(d=>{const P=d.usuario1===s,I=P?d.usuarios2:d.usuarios1,B=I||{user_id:P?d.usuario2:d.usuario1,nick:"‚Äî"};return{amistadId:d.id,amigoId:B.user_id,nick:B.nick,comparte:d.comparte_catalogo}});S(q)}async function k(s){if(!a){i("Inicia sesi√≥n primero");return}const{data:r}=await p.from("amistades").select("estado").or(`and(usuario1.eq.${a.id},usuario2.eq.${s}),and(usuario1.eq.${s},usuario2.eq.${a.id})`).maybeSingle();if(r){i({pendiente:"Ya hay una solicitud pendiente.",aceptada:"Ya sois amigos.",rechazada:"Ya existe relaci√≥n previa."}[r.estado]||"Relaci√≥n existente");return}const{error:n}=await p.from("amistades").insert([{usuario1:a.id,usuario2:s,estado:"pendiente",comparte_catalogo:!1}]);n?(console.error("Invitar:",n),i("Error al enviar invitaci√≥n")):(i("Invitaci√≥n enviada üéâ"),m(a.id)),setTimeout(()=>i(""),2e3)}async function _(s,r){a&&(await p.from("amistades").update({estado:r?"aceptada":"rechazada"}).eq("id",s),m(a.id),C(a.id))}async function H(s){a&&(await p.from("amistades").delete().eq("id",s).eq("usuario1",a.id).eq("estado","pendiente"),m(a.id))}async function U(s,r){const{error:n}=await p.from("amistades").update({comparte_catalogo:!r}).eq("id",s);n?console.error("Toggle compartir:",n):S(q=>q.map(d=>d.amistadId===s?{...d,comparte:!r}:d))}return c?e.jsxs(e.Fragment,{children:[e.jsx(R,{}),e.jsx("main",{className:"pt-20 px-4 text-center",children:e.jsx("span",{children:"Cargando usuario..."})})]}):a?e.jsxs(e.Fragment,{children:[e.jsx(R,{}),e.jsxs("div",{className:"pt-20 px-4 max-w-3xl mx-auto space-y-8",children:[e.jsxs("section",{children:[e.jsx("h2",{className:"text-xl font-semibold mb-2",children:"Buscar amigos"}),e.jsx("div",{className:"flex items-center gap-2 mb-2",children:e.jsx("input",{type:"text",className:"flex-1 border px-3 py-2 rounded",placeholder:"Nick...",value:o,onChange:s=>l(s.target.value)})}),x&&e.jsx("p",{children:"Cargando..."}),b&&e.jsx("p",{className:"text-sm text-red-600",children:b}),e.jsx("ul",{className:"space-y-2",children:N.map(s=>e.jsxs("li",{className:"flex items-center justify-between bg-white p-2 rounded shadow",children:[e.jsx("span",{children:s.nick}),e.jsx("button",{onClick:()=>k(s.user_id),className:"px-3 py-1 bg-blue-600 text-white rounded hover:bg-blue-700",children:"Invitar"})]},s.user_id))})]}),e.jsxs("section",{children:[e.jsx("h2",{className:"text-xl font-semibold mb-2",children:"Solicitudes"}),e.jsxs("div",{className:"mb-4",children:[e.jsx("h3",{className:"font-medium mb-2",children:"Entrantes"}),j.length===0?e.jsx("p",{className:"text-gray-600",children:"Ninguna"}):j.map(s=>e.jsxs("div",{className:"flex items-center justify-between bg-white p-2 rounded shadow mb-2",children:[e.jsx("span",{children:s.usuario1.nick}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx("button",{onClick:()=>_(s.id,!0),className:"px-2 py-1 bg-green-600 text-white rounded",children:"Aceptar"}),e.jsx("button",{onClick:()=>_(s.id,!1),className:"px-2 py-1 bg-red-600 text-white rounded",children:"Rechazar"})]})]},s.id))]}),e.jsxs("div",{children:[e.jsx("h3",{className:"font-medium mb-2",children:"Enviadas"}),g.length===0?e.jsx("p",{className:"text-gray-600",children:"Ninguna"}):g.map(s=>e.jsxs("div",{className:"flex items-center justify-between bg-white p-2 rounded shadow mb-2",children:[e.jsx("span",{children:s.usuario2.nick}),e.jsx("button",{onClick:()=>H(s.id),className:"px-2 py-1 bg-gray-500 text-white rounded",children:"Cancelar"})]},s.id))]})]}),e.jsxs("section",{children:[e.jsx("h2",{className:"text-xl font-semibold mb-2",children:"Tus amigos"}),v.length===0?e.jsx("p",{className:"text-gray-600",children:"A√∫n no tienes amigos."}):e.jsx("ul",{className:"space-y-2",children:v.map(s=>e.jsxs("li",{className:"flex items-center justify-between bg-white p-2 rounded shadow",children:[e.jsx("span",{onClick:()=>u(`/perfil/${s.nick}`),className:"cursor-pointer text-blue-600 hover:underline",children:s.nick}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("label",{className:"text-sm",children:"Compartir cat√°logo"}),e.jsx(A,{checked:s.comparte,onCheckedChange:()=>U(s.amistadId,s.comparte),className:"w-12 h-6 bg-gray-200 rounded-full data-[state=checked]:bg-green-500 relative",children:e.jsx("span",{className:`block w-6 h-6 bg-white rounded-full shadow transition-transform absolute top-0 left-0\r
                          data-[state=checked]:translate-x-6`,"data-state":s.comparte?"checked":"unchecked"})})]})]},s.amistadId))})]})]})]}):e.jsxs(e.Fragment,{children:[e.jsx(R,{}),e.jsx("main",{className:"pt-20 px-4 text-center",children:e.jsx("span",{children:"Debes iniciar sesi√≥n para acceder a la red social."})})]})}export{re as default};
