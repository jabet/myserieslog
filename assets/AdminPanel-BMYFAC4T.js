import{r as m,j as a}from"./index-XnMTmJ1N.js";import{s as f,u as qe}from"./useUsuario-DUZRc8QX.js";import{M as ae,g as oe,d as Be,a as Fe}from"./guardarContenidoTMDB-C5dwmokO.js";import{N as re}from"./Navbar-Brd59B00.js";import{F as se}from"./Footer-C0KuTKYv.js";const Re="b0d797f053110a25f57317b8e7ba3b06",Ue="https://api.themoviedb.org/3";async function Ge(s){try{const g=await(await fetch(`${Ue}/tv/${s}/translations?api_key=${Re}`)).json();if(!g.translations)return!1;const p=g.translations.map(c=>{var l,d;return{contenido_id:s,idioma:c.iso_639_1,nombre:((l=c.data)==null?void 0:l.name)||"",sinopsis:((d=c.data)==null?void 0:d.overview)||""}}),i=Object.values(p.reduce((c,l)=>(c[l.idioma]||(c[l.idioma]=l),c),{}));if(i.length>0){const{error:c}=await f.from("contenido_traducciones").upsert(i,{onConflict:"contenido_id,idioma"});if(c)return console.error("Error upsert traducciones:",c),!1}return!0}catch(t){return console.error("Error en actualizarTraducciones:",t),!1}}const te="b0d797f053110a25f57317b8e7ba3b06",ne="https://api.themoviedb.org/3";async function ie(s,t="es-ES"){try{console.log(`Cargando temporadas para serie ${s}...`);const p=await(await fetch(`${ne}/tv/${s}?api_key=${te}&language=${t}`)).json();if(!p.seasons)return!1;const i=[];for(const c of p.seasons){const d=await(await fetch(`${ne}/tv/${s}/season/${c.season_number}?api_key=${te}&language=${t}`)).json();if(!d.episodes)continue;const h=c.season_number===0;i.push(...d.episodes.map(u=>{var v;return{contenido_id:s,temporada:h?0:c.season_number,episodio:u.episode_number,nombre:u.name,fecha_emision:u.air_date,imagen:u.still_path?`https://image.tmdb.org/t/p/w300${u.still_path}`:null,especial:h,duracion:u.runtime||((v=p.episode_run_time)==null?void 0:v[0])||45}}))}if(i.length>0){const{error:c}=await f.from("episodios").upsert(i,{onConflict:"contenido_id,temporada,episodio"});if(c)return console.error("Error upsert episodios:",c),!1;console.log(`${i.length} episodios cargados/actualizados`)}return!0}catch(g){return console.error("Error en cargarTemporadasCapitulos:",g),!1}}const le="b0d797f053110a25f57317b8e7ba3b06",ce="https://api.themoviedb.org/3";async function de(s,t="es-ES"){var g;try{console.log(`Actualizando duraciones para serie ${s}...`);const i=await(await fetch(`${ce}/tv/${s}?api_key=${le}&language=${t}`)).json();if(!i.seasons)return!1;const c=((g=i.episode_run_time)==null?void 0:g[0])||45,{data:l}=await f.from("episodios").select("id, temporada, episodio").eq("contenido_id",s);if(!(l!=null&&l.length))return!1;const d=[],h=[...new Set(l.map(u=>u.temporada))];for(const u of h)try{const $=await(await fetch(`${ce}/tv/${s}/season/${u}?api_key=${le}&language=${t}`)).json();if($.episodes)for(const j of $.episodes){const A=l.find(b=>b.temporada===u&&b.episodio===j.episode_number);A&&d.push({id:A.id,duracion:j.runtime||c})}}catch(v){console.warn(`Error cargando temporada ${u}:`,v)}if(d.length>0){for(const u of d)await f.from("episodios").update({duracion:u.duracion}).eq("id",u.id);console.log(`${d.length} duraciones actualizadas`)}return!0}catch(p){return console.error("Error actualizando duraciones:",p),!1}}const Le="b0d797f053110a25f57317b8e7ba3b06",Ie="https://api.themoviedb.org/3";async function ue(s,t="es-ES"){try{console.log(`Actualizando duración para película ${s}...`);const g=await fetch(`${Ie}/movie/${s}?api_key=${Le}&language=${t}`);if(!g.ok)return console.error(`Error HTTP ${g.status} para película ${s}`),!1;const p=await g.json();if(!p.runtime)return console.warn(`No se encontró duración para película ${s}`),!1;const{error:i}=await f.from("contenido").update({duracion:p.runtime}).eq("id",s).eq("media_type","movie");return i?(console.error("Error actualizando duración en Supabase:",i),!1):(console.log(`✅ Duración actualizada para película ${s}: ${p.runtime} minutos`),!0)}catch(g){return console.error(`Error actualizando duración de película ${s}:`,g),!1}}async function Oe(){try{console.log("Iniciando migración de duraciones...");const{data:s}=await f.from("episodios").select("contenido_id").not("contenido_id","is",null),t=s!=null&&s.length?[...new Set(s.map(d=>d.contenido_id))]:[],{data:g}=await f.from("contenido").select("id").eq("media_type","movie"),p=(g==null?void 0:g.map(d=>d.id))||[];console.log(`Encontradas ${t.length} series y ${p.length} películas para actualizar`);let i=0,c=0;const l=t.length+p.length;for(const d of t)try{await de(d)?(i++,console.log(`✅ Serie ${d} actualizada`)):(c++,console.warn(`❌ Error en serie ${d}`)),await new Promise(u=>setTimeout(u,250))}catch(h){c++,console.error(`❌ Error en serie ${d}:`,h)}for(const d of p)try{await ue(d)?(i++,console.log(`✅ Película ${d} actualizada`)):(c++,console.warn(`❌ Error en película ${d}`)),await new Promise(u=>setTimeout(u,250))}catch(h){c++,console.error(`❌ Error en película ${d}:`,h)}return console.log(`Migración completada: ${i} exitosos, ${c} fallidos de ${l} elementos`),{exitosos:i,fallidos:c,total:l,series:t.length,peliculas:p.length}}catch(s){throw console.error("Error en migración:",s),s}}const me="b0d797f053110a25f57317b8e7ba3b06",pe="https://api.themoviedb.org/3";async function ge(s,t,g="es-ES"){try{console.log(`Actualizando géneros para ${t} ${s}...`);const i=await fetch(`${pe}/${t==="tv"?"tv":"movie"}/${s}?api_key=${me}&language=${g}`);if(!i.ok)return i.status===404?(console.warn(`⚠️ Contenido ${t} ${s} no encontrado en TMDb (404) - posiblemente eliminado`),await f.from("contenido").update({generos:["No disponible"],ultima_actualizacion:new Date().toISOString()}).eq("id",s).eq("media_type",t),!1):(console.error(`Error HTTP ${i.status} para ${t} ${s}`),!1);const c=await i.json();if(!c.genres||c.genres.length===0)return console.warn(`Sin géneros disponibles para ${t} ${s}`),await f.from("contenido").update({generos:[],ultima_actualizacion:new Date().toISOString()}).eq("id",s).eq("media_type",t),!1;const l=c.genres.map(h=>h.name),{error:d}=await f.from("contenido").update({generos:l,ultima_actualizacion:new Date().toISOString()}).eq("id",s).eq("media_type",t);return d?(console.error("Error actualizando géneros en Supabase:",d),!1):(console.log(`✅ Géneros actualizados para ${t} ${s}:`,l),!0)}catch(p){return console.error(`Error actualizando géneros de ${t} ${s}:`,p),!1}}async function Ke(){try{console.log("Iniciando migración de géneros...");const{data:s,error:t}=await f.from("contenido").select("id, media_type, nombre, generos").or("generos.is.null,generos.eq.{}");if(t)throw console.error("Error en consulta:",t),t;if(!(s!=null&&s.length))return console.log("No hay contenido sin géneros para actualizar"),{exitosos:0,fallidos:0,total:0,noEncontrados:0};const g=s.filter(l=>{const d=l.generos;return!d||d.length===0||Array.isArray(d)&&!d.includes("No disponible")});if(!g.length)return console.log("No hay contenido sin géneros para actualizar (después del filtrado)"),{exitosos:0,fallidos:0,total:0,noEncontrados:0};console.log(`Encontrados ${g.length} elementos sin géneros`);let p=0,i=0,c=0;for(const l of g)try{if(console.log(`🔄 Procesando ${l.media_type} ${l.id} - "${l.nombre}"`),await ge(l.id,l.media_type))p++,console.log(`✅ ${l.media_type} ${l.id} actualizado`);else try{(await fetch(`${pe}/${l.media_type==="tv"?"tv":"movie"}/${l.id}?api_key=${me}`)).status===404?(c++,console.warn(`❌ ${l.media_type} ${l.id} no existe en TMDb`)):(i++,console.warn(`❌ Error en ${l.media_type} ${l.id}`))}catch(h){i++,console.error(`❌ Error verificando ${l.media_type} ${l.id}:`,h)}await new Promise(h=>setTimeout(h,250))}catch(d){i++,console.error(`❌ Error en ${l.media_type} ${l.id}:`,d)}return console.log("Migración de géneros completada:"),console.log(`- Exitosos: ${p}`),console.log(`- Fallidos: ${i}`),console.log(`- No encontrados en TMDb: ${c}`),{exitosos:p,fallidos:i,noEncontrados:c,total:g.length}}catch(s){throw console.error("Error en migración de géneros:",s),s}}const Q={emoji:"🏆",nombre:"Logro de Ejemplo",descripcion:"Has desbloqueado un logro de prueba."};function Ye({usuarios:s,onNotificacionEnviada:t,series:g=[]}){const[p,i]=m.useState(""),[c,l]=m.useState(""),[d,h]=m.useState(""),[u,v]=m.useState(""),[$,j]=m.useState(""),[A,b]=m.useState(""),U=s.map(x=>a.jsxs("option",{value:x.user_id,children:[x.nick?x.nick:x.user_id," ",x.rol?`(${x.rol})`:""]},x.user_id)),M=[a.jsx("option",{value:"",children:"Sin imagen de serie"},""),...g.map(x=>a.jsxs("option",{value:x.id,children:[x.nombre," (",x.id,")"]},x.id))],G=async x=>{if(x.preventDefault(),!p){b("Debes seleccionar un usuario.");return}b("Enviando...");let w=null;if($){const E=g.find(L=>String(L.id)===String($));w=(E==null?void 0:E.imagen)||null}const{error:P}=await f.from("notificaciones_usuario").insert([{user_id:p,titulo:c,mensaje:d,url:u,imagen:w}]);P?b("Error al enviar: "+P.message):(b("¡Notificación enviada!"),l(""),h(""),v(""),i(""),j(""),t&&t())},k=async()=>{if(!p){b("Selecciona un usuario para simular el logro.");return}b("Enviando notificación de logro...");const{error:x}=await f.from("notificaciones_usuario").insert([{user_id:p,titulo:"¡Nuevo logro desbloqueado!",mensaje:`${Q.emoji} ${Q.nombre}: ${Q.descripcion}`,url:"/perfil#logros",imagen:"🎉"}]);x?b("Error al enviar: "+x.message):(b("¡Notificación de logro enviada!"),t&&t())};return a.jsxs("div",{className:"max-w-md mx-auto my-8 p-4 bg-white rounded shadow",children:[a.jsx("h2",{className:"font-bold mb-2",children:"Enviar notificación"}),a.jsxs("form",{onSubmit:G,className:"flex flex-col gap-2",children:[a.jsxs("select",{value:p,onChange:x=>i(x.target.value),className:"border px-2 py-1 rounded",required:!0,children:[a.jsx("option",{value:"",children:"Selecciona usuario"}),U]}),a.jsx("input",{type:"text",placeholder:"Título",value:c,onChange:x=>l(x.target.value),className:"border px-2 py-1 rounded",required:!0}),a.jsx("input",{type:"text",placeholder:"Mensaje",value:d,onChange:x=>h(x.target.value),className:"border px-2 py-1 rounded",required:!0}),a.jsx("input",{type:"text",placeholder:"URL destino (opcional)",value:u,onChange:x=>v(x.target.value),className:"border px-2 py-1 rounded"}),a.jsx("select",{value:$,onChange:x=>j(x.target.value),className:"border px-2 py-1 rounded",children:M}),a.jsx("button",{type:"submit",className:"bg-blue-600 text-white px-3 py-1 rounded hover:bg-blue-700",children:"Enviar notificación"})]}),a.jsx("button",{className:"mt-3 bg-green-600 text-white px-3 py-1 rounded hover:bg-green-700 w-full",onClick:k,type:"button",children:"Simular notificación de logro"}),A&&a.jsx("div",{className:"mt-2 text-sm",children:A})]})}function la(){const{usuario:s,perfil:t,esAdmin:g,loading:p}=qe(),[i,c]=m.useState([]),[l,d]=m.useState([]),[h,u]=m.useState(!0),[v,$]=m.useState(""),[j,A]=m.useState("id"),[b,U]=m.useState("asc"),[M,G]=m.useState("contenidos"),[k,x]=m.useState(!1),[w,P]=m.useState(null),[E,L]=m.useState(!1),[N,O]=m.useState(null),[W,xe]=m.useState(""),[K,he]=m.useState(""),[Y,fe]=m.useState(""),[D,H]=m.useState(1),B=25,[be,ye]=m.useState([]),F=i.filter(e=>(e.nombre||"").toLowerCase().includes(W.toLowerCase())&&(K?e.tipo===K:!0)&&(Y===""||String(e.id).includes(Y))),q=Math.ceil(F.length/B),[X,je]=m.useState([]),[He,Ve]=m.useState(""),[Je,Qe]=m.useState(""),[We,Xe]=m.useState(""),[Ze,ea]=m.useState(""),[aa,oa]=m.useState("");m.useEffect(()=>{!s||(t==null?void 0:t.rol)!=="admin"||(u(!0),f.from("contenido").select(`
        id,
        nombre,
        nombre_original,
        tipo,
        media_type,
        anio,
        finalizada,
        ultima_actualizacion,
        sinopsis,
        imagen,
        backdrop,
        generos,
        puntuacion,
        popularidad,
        duracion,
        temporadas,
        episodios_totales,
        estado_serie,
        en_emision,
        reparto,
        original_language,
        origin_country
      `).order(j,{ascending:b==="asc"}).then(({data:e,error:o})=>{o?console.error("Error al cargar contenidos:",o):c(e||[]),u(!1)}))},[s,t==null?void 0:t.rol,j,b]),m.useEffect(()=>{!s||(t==null?void 0:t.rol)!=="admin"||(u(!0),f.from("usuarios").select("user_id, rol").order("user_id",{ascending:!0}).then(({data:e,error:o})=>{o?console.error("Error al cargar usuarios:",o):d(e||[]),u(!1)}))},[s,t==null?void 0:t.rol,j,b,M]);const we=e=>e?new Date(e).toLocaleString("es-ES",{dateStyle:"short",timeStyle:"short"}):"-",n=e=>{$(e),setTimeout(()=>$(""),3e3)},Ne=async(e,o)=>{await oe(e,o,"es-ES")?(n(`Contenido ${e} actualizado con éxito`),Z()):n(`Fallo al actualizar ${e}`)},_e=async(e,o)=>{console.log("Actualizando traducciones:",e,o);const r=await Ge(e);n(r?`Traducciones de ${e} actualizadas con éxito`:`Fallo al actualizar traducciones de ${e}`)},ve=async(e,o)=>{if(console.log("Cargar temporadas/capítulos:",e,o),o!=="tv")return;const r=await ie(e,"es-ES");n(r?`Temporadas y capítulos de ${e} cargados con éxito`:`Fallo al cargar temporadas/capítulos de ${e}`)},$e=async(e,o)=>{if(console.log("Forzar actualización de todas las temporadas:",e,o),o!=="tv")return;n("Forzando actualización de todas las temporadas...");const r=await ie(e,"es-ES");n(r?`Temporadas y capítulos de ${e} actualizados en Supabase`:`Fallo al actualizar temporadas/capítulos de ${e}`)},ze=async e=>{if(console.log("Eliminando contenido:",e),!confirm(`¿Seguro que quieres borrar el contenido ${e}?`))return;const{error:o}=await f.from("contenido").delete().eq("id",e);o?(console.error("Error borrando contenido:",o),n(`Error al borrar contenido ${e}`)):(c(r=>r.filter(z=>z.id!==e)),n(`Contenido ${e} borrado`))},S=e=>{j===e?U(o=>o==="asc"?"desc":"asc"):(A(e),U("asc"))},T=e=>j===e?b==="asc"?" ▲":" ▼":"",Ee=async(e,o)=>{if(o!=="tv"){n("Solo se pueden actualizar duraciones de series");return}n("Actualizando duraciones de episodios...");const r=await de(e,"es-ES");n(r?`Duraciones de episodios de ${e} actualizadas`:`Error al actualizar duraciones de ${e}`)},Se=async(e,o)=>{if(o!=="movie"){n("Solo se pueden actualizar duraciones de películas");return}n("Actualizando duración de película...");const r=await ue(e,"es-ES");n(r?`Duración de película ${e} actualizada`:`Error al actualizar duración de ${e}`)},Te=async(e,o)=>{if(n("Actualizando géneros..."),await ge(e,o,"es-ES")){n(`Géneros de ${o} ${e} actualizados`),u(!0);const{data:z,error:I}=await f.from("contenido").select("id, nombre, tipo, media_type, anio, finalizada, ultima_actualizacion").order(j,{ascending:b==="asc"});I?console.error("Error al cargar contenidos:",I):c(z||[]),u(!1)}else n(`Error al actualizar géneros de ${e}`)},Ae=async()=>{if(confirm("¿Estás seguro de que quieres migrar las duraciones de todas las series y películas? Esto puede tardar varios minutos.")){x(!0),P(null),n("Iniciando migración de duraciones...");try{const e=await Oe(je);P(e),n(`✅ Migración completada: ${e.exitosos} exitosos, ${e.fallidos} fallidos de ${e.total} elementos`)}catch(e){console.error("Error en migración:",e),n("❌ Error durante la migración"),P({error:e.message})}finally{x(!1)}}},Me=async()=>{if(confirm("¿Estás seguro de que quieres migrar los géneros de todo el contenido? Esto puede tardar varios minutos.")){L(!0),O(null),n("Iniciando migración de géneros...");try{const e=await Ke();O(e),n(`✅ Migración de géneros completada: ${e.exitosos} exitosos, ${e.fallidos} fallidos de ${e.total} elementos`),u(!0);const{data:o,error:r}=await f.from("contenido").select("id, nombre, tipo, media_type, anio, finalizada, ultima_actualizacion").order(j,{ascending:b==="asc"});r?console.error("Error al cargar contenidos:",r):c(o||[]),u(!1)}catch(e){console.error("Error en migración de géneros:",e),n("❌ Error durante la migración de géneros"),O({error:e.message})}finally{L(!1)}}},Z=async()=>{u(!0);try{const{data:e,error:o}=await f.from("contenido").select("id, nombre, tipo, media_type, anio, finalizada, ultima_actualizacion").order(j,{ascending:b==="asc"});o?(console.error("Error al cargar contenidos:",o),n("Error cargando contenidos")):c(e||[])}catch(e){console.error("Error:",e),n("Error inesperado")}finally{u(!1)}};m.useEffect(()=>{const e=Array.from(new Set(i.map(o=>o.tipo).filter(Boolean)));ye(e)},[i]);const V=F.slice((D-1)*B,D*B),[y,R]=m.useState([]),[_,De]=m.useState("");if(p||!s)return null;if(!g)return a.jsxs(a.Fragment,{children:[a.jsx(re,{}),a.jsx("main",{className:"pt-20 px-4 text-center",children:a.jsx(ae,{texto:"Acceso denegado: solo admins."})}),a.jsx(se,{})]});const ee=async e=>{const o=i.find(z=>z.id===e);if(!o)return;const r=Be(o,o.media_type,o.generos);if(r&&r!==o.tipo){const{error:z}=await f.from("contenido").update({tipo:r}).eq("id",e);z?n("Error al actualizar el tipo"):(c(I=>I.map(J=>J.id===e?{...J,tipo:r}:J)),n(`Tipo recalculado: ${r}`))}else n("El tipo ya está correcto")},Ce=async()=>{for(const e of y)await ee(e),await new Promise(o=>setTimeout(o,150));n("Tipos recalculados")};l.map(e=>a.jsxs("option",{value:e.user_id,children:[e.nick?e.nick:e.user_id," ",e.rol?`(${e.rol})`:""]},e.user_id));const C=i.filter(e=>!e.sinopsis||!e.imagen||!e.generos||Array.isArray(e.generos)&&e.generos.length===0?!0:e.media_type==="movie"?!e.duracion||e.duracion===0:e.media_type==="tv"?!e.temporadas||e.temporadas===0||!e.episodios_totales||e.episodios_totales===0:!1);function ke(e){if(!e.sinopsis)return"sinopsis";if(!e.imagen)return"imagen";if(!e.generos||Array.isArray(e.generos)&&e.generos.length===0)return"géneros";if(e.media_type==="movie"&&(!e.duracion||e.duracion===0))return"duración";if(e.media_type==="tv"){if(!e.temporadas||e.temporadas===0)return"temporadas";if(!e.episodios_totales||e.episodios_totales===0)return"episodios"}return"dato desconocido"}const Pe=async()=>{if(C.length===0){n("No hay contenidos incompletos.");return}n("Actualizando contenidos incompletos...");for(const e of C)await oe(e.id,e.media_type,"es-ES"),e.media_type==="tv"&&await Fe(e.id,"es-ES"),await f.from("contenido").update({ultima_actualizacion:new Date().toISOString()}).eq("id",e.id),await new Promise(o=>setTimeout(o,300));n("Actualización de incompletos finalizada."),Z()};return a.jsxs(a.Fragment,{children:[a.jsx(re,{}),a.jsx(ae,{texto:v}),a.jsxs("main",{className:"pt-20 px-4 max-w-4xl mx-auto",children:[a.jsx("h1",{className:"text-2xl font-bold mb-4",children:"Panel de Administración"}),a.jsxs("div",{className:"mb-4",children:[a.jsx("button",{onClick:()=>G("contenidos"),className:`px-4 py-2 rounded-l-lg font-medium transition-all ${M==="contenidos"?"bg-blue-600 text-white shadow-md":"bg-gray-200 text-gray-700 hover:bg-gray-300"}`,children:"📺 Contenidos"}),a.jsx("button",{onClick:()=>G("usuarios"),className:`px-4 py-2 rounded-r-lg font-medium transition-all ${M==="usuarios"?"bg-blue-600 text-white shadow-md":"bg-gray-200 text-gray-700 hover:bg-gray-300"}`,children:"👥 Usuarios"})]}),h?a.jsxs("p",{children:["Cargando ",M==="contenidos"?"contenidos":"usuarios","…"]}):M==="contenidos"?i.length===0?a.jsx("p",{children:"No hay contenidos en la base de datos."}):a.jsxs(a.Fragment,{children:[a.jsxs("div",{className:"flex gap-4 mb-4",children:[a.jsx("input",{type:"text",placeholder:"Buscar por nombre...",value:W,onChange:e=>xe(e.target.value),className:"border px-2 py-1 rounded"}),a.jsxs("select",{value:K,onChange:e=>he(e.target.value),className:"border px-2 py-1 rounded",children:[a.jsx("option",{value:"",children:"Todos los tipos"}),be.map(e=>a.jsx("option",{value:e,children:e},e))]}),a.jsx("input",{type:"text",placeholder:"Buscar por ID...",value:Y,onChange:e=>fe(e.target.value),className:"border px-2 py-1 rounded w-24"})]}),a.jsxs("div",{className:"my-4 flex gap-2 items-center",children:[a.jsxs("select",{value:_,onChange:e=>De(e.target.value),className:"border px-2 py-1 rounded",children:[a.jsx("option",{value:"",children:"Selecciona una acción"}),a.jsx("option",{value:"borrar",children:"Borrar seleccionados"}),a.jsx("option",{value:"actualizar_contenido",children:"Actualizar contenido"}),a.jsx("option",{value:"actualizar_traducciones",children:"Actualizar traducciones"}),a.jsx("option",{value:"cargar_temporadas",children:"Cargar temporadas/capítulos"}),a.jsx("option",{value:"forzar_actualizar_temporadas",children:"Forzar actualización temporadas"}),a.jsx("option",{value:"actualizar_duraciones",children:"Actualizar duraciones (series)"}),a.jsx("option",{value:"actualizar_duracion_pelicula",children:"Actualizar duración (películas)"}),a.jsx("option",{value:"actualizar_generos",children:"Actualizar géneros"}),a.jsx("option",{value:"recalcular_tipo",children:"Recalcular tipo"})]}),a.jsx("button",{className:"bg-blue-600 text-white px-3 py-1 rounded hover:bg-blue-700",onClick:async()=>{if(y.length===0){n("Selecciona al menos un elemento");return}if(!_){n("Selecciona una acción");return}if(u(!0),_==="borrar"){if(!confirm(`¿Seguro que quieres borrar ${y.length} contenidos?`)){u(!1);return}const{error:e}=await f.from("contenido").delete().in("id",y);e?n("Error al borrar contenidos seleccionados"):(c(o=>o.filter(r=>!y.includes(r.id))),R([]),n("Contenidos borrados correctamente"))}if(_==="actualizar_contenido"){for(const e of y){const o=i.find(r=>r.id===e);o&&await Ne(o.id,o.media_type),await new Promise(r=>setTimeout(r,250))}n("Contenidos actualizados")}if(_==="actualizar_traducciones"){for(const e of y){const o=i.find(r=>r.id===e);o&&await _e(o.id,o.media_type),await new Promise(r=>setTimeout(r,250))}n("Traducciones actualizadas")}if(_==="cargar_temporadas"){for(const e of y){const o=i.find(r=>r.id===e);o&&o.media_type==="tv"&&await ve(o.id,o.media_type),await new Promise(r=>setTimeout(r,250))}n("Temporadas/capítulos cargados")}if(_==="forzar_actualizar_temporadas"){for(const e of y){const o=i.find(r=>r.id===e);o&&o.media_type==="tv"&&await $e(o.id,o.media_type),await new Promise(r=>setTimeout(r,250))}n("Temporadas actualizadas")}if(_==="actualizar_duraciones"){for(const e of y){const o=i.find(r=>r.id===e);o&&o.media_type==="tv"&&await Ee(o.id,o.media_type),await new Promise(r=>setTimeout(r,250))}n("Duraciones de series actualizadas")}if(_==="actualizar_duracion_pelicula"){for(const e of y){const o=i.find(r=>r.id===e);o&&o.media_type==="movie"&&await Se(o.id,o.media_type),await new Promise(r=>setTimeout(r,250))}n("Duraciones de películas actualizadas")}if(_==="actualizar_generos"){for(const e of y){const o=i.find(r=>r.id===e);o&&await Te(o.id,o.media_type),await new Promise(r=>setTimeout(r,250))}n("Géneros actualizados")}if(_==="recalcular_tipo"){await Ce(),u(!1);return}u(!1)},children:"Aplicar"})]}),C.length>0&&a.jsxs("div",{className:"mb-4 p-4 bg-yellow-50 border border-yellow-200 rounded",children:[a.jsxs("div",{className:"flex items-center justify-between mb-2",children:[a.jsxs("span",{className:"font-semibold text-yellow-800",children:["Contenidos incompletos detectados:"," ",C.length]}),a.jsx("button",{className:"bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700",onClick:Pe,children:"Actualizar desde TMDb"})]}),a.jsxs("ul",{className:"list-disc ml-6 text-yellow-900 text-sm max-h-32 overflow-y-auto",children:[C.slice(0,10).map(e=>a.jsxs("li",{children:["#",e.id," -"," ",e.nombre||a.jsx("span",{className:"italic text-gray-400",children:"Sin nombre"}),a.jsxs("span",{className:"ml-2 text-xs text-yellow-700",children:["(falta: ",a.jsx("strong",{children:ke(e)}),")"]})]},e.id)),C.length>10&&a.jsxs("li",{className:"italic text-gray-500",children:["...y ",C.length-10," más"]})]})]}),a.jsxs("table",{className:"w-full table-auto border-collapse text-sm",children:[a.jsx("thead",{children:a.jsxs("tr",{className:"bg-gray-100",children:[a.jsx("th",{className:"border px-2 py-1",children:a.jsx("input",{type:"checkbox",checked:y.length>0&&y.length===V.length,onChange:e=>{e.target.checked?R(V.map(o=>o.id)):R([])}})}),a.jsxs("th",{className:"border px-2 py-1 cursor-pointer",onClick:()=>S("id"),children:["ID",T("id")]}),a.jsxs("th",{className:"border px-2 py-1 cursor-pointer",onClick:()=>S("nombre"),children:["Nombre",T("nombre")]}),a.jsxs("th",{className:"border px-2 py-1 cursor-pointer",onClick:()=>S("tipo"),children:["Tipo",T("tipo")]}),a.jsxs("th",{className:"border px-2 py-1 cursor-pointer",onClick:()=>S("anio"),children:["Año",T("anio")]}),a.jsxs("th",{className:"border px-2 py-1 cursor-pointer",onClick:()=>S("finalizada"),children:["Finalizada",T("finalizada")]}),a.jsxs("th",{className:"border px-2 py-1 cursor-pointer",onClick:()=>S("ultima_actualizacion"),children:["Última Actualización",T("ultima_actualizacion")]}),a.jsx("th",{className:"border px-2 py-1",children:"Título original"}),a.jsx("th",{className:"border px-2 py-1",children:"Puntuación"}),a.jsx("th",{className:"border px-2 py-1",children:"Géneros"}),a.jsx("th",{className:"border px-2 py-1",children:"Imagen"})]})}),a.jsx("tbody",{children:V.map(e=>a.jsxs("tr",{children:[a.jsx("td",{className:"border px-2 py-1",children:a.jsx("input",{type:"checkbox",checked:y.includes(e.id),onChange:o=>{o.target.checked?R(r=>[...r,e.id]):R(r=>r.filter(z=>z!==e.id))}})}),a.jsx("td",{className:"border px-2 py-1",children:e.id}),a.jsx("td",{className:"border px-2 py-1",children:a.jsx("a",{href:`#/detalle/${e.media_type}/${e.id}`,className:"text-blue-700 underline hover:text-blue-900",target:"_blank",rel:"noopener noreferrer",children:e.nombre||a.jsx("span",{className:"text-gray-400 italic",children:"Sin nombre"})})}),a.jsx("td",{className:"border px-2 py-1",children:e.tipo}),a.jsx("td",{className:"border px-2 py-1",children:e.anio}),a.jsx("td",{className:"border px-2 py-1",children:e.finalizada?"Sí":"No"}),a.jsx("td",{className:"border px-2 py-1",children:we(e.ultima_actualizacion)}),a.jsx("td",{className:"border px-2 py-1",children:e.nombre_original}),a.jsx("td",{className:"border px-2 py-1",children:e.puntuacion??"-"}),a.jsx("td",{className:"border px-2 py-1",children:Array.isArray(e.generos)?e.generos.join(", "):typeof e.generos=="string"?e.generos:"-"}),a.jsx("td",{className:"border px-2 py-1",children:e.imagen&&a.jsx("img",{src:e.imagen,alt:e.nombre||"miniatura",style:{width:40,borderRadius:4,objectFit:"cover"}})}),a.jsx("td",{className:"border px-2 py-1",children:a.jsx("button",{className:"text-xs bg-blue-100 text-blue-800 px-2 py-1 rounded hover:bg-blue-200",onClick:()=>ee(e.id),title:"Recalcular tipo",children:"Recalcular tipo"})})]},e.id))})]}),a.jsxs("div",{className:"flex flex-col md:flex-row justify-between items-center gap-2 my-4",children:[a.jsxs("span",{children:["Mostrando"," ",F.length===0?0:(D-1)*B+1,"-",Math.min(D*B,F.length)," de"," ",F.length," resultados"]}),a.jsxs("div",{className:"flex items-center gap-2",children:[a.jsx("button",{className:"px-2 py-1 rounded bg-gray-200 hover:bg-gray-300",onClick:()=>H(e=>Math.max(1,e-1)),disabled:D===1,"aria-label":"Página anterior",children:"Anterior"}),a.jsxs("span",{children:["Página"," ",a.jsx("input",{type:"number",min:1,max:q,value:D,onChange:e=>{let o=Number(e.target.value);(isNaN(o)||o<1)&&(o=1),o>q&&(o=q),H(o)},className:"w-12 text-center border rounded","aria-label":"Número de página"})," ","de ",q]}),a.jsx("button",{className:"px-2 py-1 rounded bg-gray-200 hover:bg-gray-300",onClick:()=>H(e=>Math.min(q,e+1)),disabled:D===q,"aria-label":"Página siguiente",children:"Siguiente"})]})]})]}):a.jsx(a.Fragment,{children:a.jsxs("table",{className:"w-full table-auto border-collapse",children:[a.jsx("thead",{children:a.jsxs("tr",{className:"bg-gray-100",children:[a.jsxs("th",{className:"border px-2 py-1 cursor-pointer",onClick:()=>S("user_id"),children:["ID",T("user_id")]}),a.jsxs("th",{className:"border px-2 py-1 cursor-pointer",onClick:()=>S("rol"),children:["Rol",T("rol")]}),a.jsx("th",{className:"border px-2 py-1",children:"Acciones"})]})}),a.jsx("tbody",{children:l.map(e=>a.jsxs("tr",{children:[a.jsx("td",{className:"border px-2 py-1",children:e.user_id}),a.jsx("td",{className:"border px-2 py-1",children:e.rol}),a.jsx("td",{className:"border px-2 py-1 space-x-2",children:a.jsx("button",{onClick:()=>ze(e.user_id),className:"text-sm bg-red-600 text-white px-2 py-1 rounded hover:bg-red-700",children:"Borrar usuario"})})]},e.user_id))})]})}),a.jsxs("section",{className:"mt-8 p-6 bg-yellow-50 border border-yellow-200 rounded-lg",children:[a.jsxs("div",{className:"flex items-center justify-between mb-4",children:[a.jsx("h2",{className:"text-lg font-semibold text-yellow-800",children:"🚀 Migración de Datos"}),k&&a.jsxs("div",{className:"flex items-center gap-2 text-yellow-700",children:[a.jsx("div",{className:"animate-spin rounded-full h-4 w-4 border-b-2 border-yellow-600"}),a.jsx("span",{className:"text-sm",children:"Procesando..."})]})]}),a.jsxs("div",{className:"space-y-4",children:[a.jsxs("div",{children:[a.jsx("h3",{className:"font-medium text-yellow-800 mb-2",children:"Actualizar Duraciones de Episodios"}),a.jsx("p",{className:"text-sm text-yellow-700 mb-3",children:"Actualiza las duraciones de todos los episodios existentes desde TMDb. Esto puede tardar varios minutos dependiendo del número de series."}),a.jsx("button",{onClick:Ae,disabled:k,className:`px-4 py-2 text-white rounded font-medium transition-colors ${k?"bg-gray-400 cursor-not-allowed":"bg-yellow-600 hover:bg-yellow-700"}`,children:k?a.jsxs(a.Fragment,{children:[a.jsx("span",{className:"animate-pulse mr-2",children:"⏳"}),"Migrando duraciones..."]}):a.jsxs(a.Fragment,{children:[a.jsx("span",{className:"mr-2",children:"⏱️"}),"Migrar Duraciones"]})})]}),w&&a.jsxs("div",{className:`p-4 rounded-lg ${w.error?"bg-red-50 border border-red-200":"bg-green-50 border border-green-200"}`,children:[a.jsx("h4",{className:`font-semibold mb-2 ${w.error?"text-red-800":"text-green-800"}`,children:w.error?"❌ Error en la migración":"✅ Migración completada"}),w.error?a.jsx("p",{className:"text-red-700 text-sm",children:w.error}):a.jsxs("div",{className:"text-green-700 text-sm space-y-1",children:[a.jsxs("p",{children:[a.jsx("strong",{children:"Total de series procesadas:"})," ",w.total]}),a.jsxs("p",{children:[a.jsx("strong",{children:"Actualizaciones exitosas:"})," ",w.exitosos]}),a.jsxs("p",{children:[a.jsx("strong",{children:"Errores:"})," ",w.fallidos]}),w.fallidos>0&&a.jsx("p",{className:"text-yellow-600",children:"⚠️ Revisa la consola para ver detalles de los errores"})]})]}),a.jsxs("div",{className:"text-xs text-yellow-600 space-y-1",children:[a.jsx("p",{children:"• Esta operación consultará la API de TMDb para cada serie"}),a.jsx("p",{children:"• Se aplicará un retraso de 250ms entre consultas para respetar los límites de la API"}),a.jsx("p",{children:"• Los logs detallados se mostrarán en la consola del navegador"})]})]})]}),a.jsxs("section",{className:"mt-8 p-6 bg-green-50 border border-green-200 rounded-lg",children:[a.jsxs("div",{className:"flex items-center justify-between mb-4",children:[a.jsx("h2",{className:"text-lg font-semibold text-green-800",children:"🎭 Migración de Géneros"}),E&&a.jsxs("div",{className:"flex items-center gap-2 text-green-700",children:[a.jsx("div",{className:"animate-spin rounded-full h-4 w-4 border-b-2 border-green-600"}),a.jsx("span",{className:"text-sm",children:"Procesando..."})]})]}),a.jsxs("div",{className:"space-y-4",children:[a.jsxs("div",{children:[a.jsx("h3",{className:"font-medium text-green-800 mb-2",children:"Actualizar Géneros desde TMDb"}),a.jsx("p",{className:"text-sm text-green-700 mb-3",children:"Actualiza los géneros de todo el contenido que no tenga géneros asignados desde TMDb."}),a.jsx("button",{onClick:Me,disabled:E,className:`px-4 py-2 text-white rounded font-medium transition-colors ${E?"bg-gray-400 cursor-not-allowed":"bg-green-600 hover:bg-green-700"}`,children:E?a.jsxs(a.Fragment,{children:[a.jsx("span",{className:"animate-pulse mr-2",children:"⏳"}),"Migrando géneros..."]}):a.jsxs(a.Fragment,{children:[a.jsx("span",{className:"mr-2",children:"🎭"}),"Migrar Géneros"]})})]}),N&&a.jsxs("div",{className:`p-4 rounded-lg ${N.error?"bg-red-50 border border-red-200":"bg-green-50 border border-green-200"}`,children:[a.jsx("h4",{className:`font-semibold mb-2 ${N.error?"text-red-800":"text-green-800"}`,children:N.error?"❌ Error en la migración":"✅ Migración completada"}),N.error?a.jsx("p",{className:"text-red-700 text-sm",children:N.error}):a.jsxs("div",{className:"text-green-700 text-sm space-y-1",children:[a.jsxs("p",{children:[a.jsx("strong",{children:"Total de elementos procesados:"})," ",N.total]}),a.jsxs("p",{children:[a.jsx("strong",{children:"Actualizaciones exitosas:"})," ",N.exitosos]}),a.jsxs("p",{children:[a.jsx("strong",{children:"Errores:"})," ",N.fallidos]}),N.noEncontrados>0&&a.jsxs("p",{children:[a.jsx("strong",{children:"No encontrados en TMDb:"})," ",a.jsx("span",{className:"text-yellow-600",children:N.noEncontrados})]}),(N.fallidos>0||N.noEncontrados>0)&&a.jsx("p",{className:"text-yellow-600 mt-2",children:"⚠️ Revisa la consola para ver detalles"})]})]})]})]}),X.length>0&&a.jsx("div",{className:"bg-gray-900 text-green-200 p-2 mt-2 rounded max-h-40 overflow-y-auto text-xs",children:X.map((e,o)=>a.jsx("div",{children:e},o))}),a.jsx(Ye,{usuarios:l,series:i.filter(e=>e.tipo==="serie"||e.media_type==="tv"),onNotificacionEnviada:()=>{window.dispatchEvent(new Event("notificacion-enviada"))}})]}),a.jsx(se,{})]})}export{la as default};
